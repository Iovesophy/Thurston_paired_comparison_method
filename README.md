# Thurston_paired_comparison_method
Thurston_paired_comparison_method

# 一対比較法における一意性の検定

Python3などを利用して一対比較法における一意性の検定を行いたいが、こういった統計を始めるにも、基礎知識がないと、入門書すら読めない。またそこまで（実際の集計手順から検定完了まで）、ちゃんとまとめて解説しているものが見当たらない感じ。
ということで最低限必要な基礎知識から実際の計算方法、実装までこの記事で書けたらいいなと思っています。
実際にどのようにして集計から検定を行うのか、ピンポイントの情報がなかったので、自分用メモとして残す目的です。

# 環境
どの処理ソフトを使おうが、あまり影響はないと思いますが、今回はPython3系を利用。

# 一対比較法とは
一対比較法概要[^1]
>順位法では、感覚や好みの強さを測るのに、全ての試料を一度に評価して順位付けする必要があります。
試料数が多くなると、一度に順位付けすることが困難になることがあります。
そのような場合、２つの試料を対にして比較します。これを全ての対について行う方法が一対比較法です。

### 一対比較法における試験の主な種類

+ 一意性の係数
+ 一致性の係数
+ ブラッドレイの一対比較法
+ サーストンの一対比較法
+ シェフェの一対比較法

etc..

今回は一意性の係数を取り扱う
例えば３つの試料A、B、Cがある時、A>B、B>Cならば、A>Cであるはず。
では実際に、このようになっているかを検定する。

##　手法について

人間の好みや匙加減を測るときには、以下のような状況が生じる可能性がある。
例えば、A、B、Cの３つの試料の評価時に、実際に評価を行うとA=Cや、A>Cと評価されてしまい、一貫した評価がなされない状況が生じる。
このような３者間で順位がつけられない状態を一巡三角形と呼ぶ。

![循環三角.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/110060/e4ff347e-5ef4-7945-8e9a-a82df326eb35.png)

**A>B、B>CならA>Cなはずである、しかし時に、A<Cな場合がある。**

***

$$A>B>C$$

$$A>B,B>C,C<A$$
***
$$A>B>C>A$$

$$A>B,B>C,C>A$$

***

言い換えると、
**AはBより大きい(A>B),BはCより大きい(B>C)ならばAはCより大きい(A>C)はずである**、
（直観的に考えてもこうなると思います）

しかし時に、AはCより小さい(A<C)場合がある。

試料の数がn個あった時に、
3つずつ組み合わせて(A,B,C)
一巡三角形の数を数える場合、

$$d (一巡三角形数)$$

一巡三角形が生じる確率が十分に小さいなら、各試料間に順位をつけられる、
つまり、順位に一意性があったと考えてよい。

この検定法を一意性の検定という。

具体的には、

![好み.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/110060/fcda33d6-683d-a7b7-5b90-998a2e293056.png)


A ～ Fの6つの試料に対して、どちらがより好きかということを考えてみる。
図中の矢印は、A → Bは、AよりもBの方が好きなことを示すものとする。

### 表１
|  i>j  | $A_j$ | $B_j$ | $C_j$ | $D_j$ | $E_j$ | $F_j$ | $a_i$=計 |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| $A_i$ | - |   |   |   |   | 1 | $a_1=1$ |
| $B_i$ | 1 | - |   |   |   | 1 | $a_2=2$ |
| $C_i$ | 1 | 1 | - |   | 1 |   | $a_3=3$ |
| $D_i$ | 1 | 1 | 1 | - |   |   | $a_4=3$ |
| $E_i$ | 1 | 1 |   | 1 | - | 1 | $a_5=4$ |
| $F_i$ |   |   | 1 | 1 |   | - | $a_6=2$ |


また、表中の数値$1$は、例えば、1列目$A_j$、2行目$B_i$の1は$A_j$よりも$B_i$の方が好きなことを示すものとする。
この時、6つの試料間に好みの順位が存在すると考えてよいのか考えてみる。[^2] [^3]

(kは試料数)$k=6$の場合は、
$$d ≦ 1$$の時に、5％水準で試料間に有意な順位があるといえる。

$k=7$の場合は、$$d ≦ 3$$の時に、5％水準で試料間に有意な順位があるといえる。

また、$$k ≧ 8$$ の時は、カイ二乗検定を行うことにより統計的に有意な順位であるかを判定することができる。

ここで、この検定を行う際に注意しなければならない点であるが、

$$k = 5$$の時、一巡三角形の数（$d$）が0個の場合には一意性あるといえる。
ただし、１個以上の場合には一意性がないと判断できるが、検定の有意水準が通常の5%ではなく、12%水準での検定となる。

また、$$k ≦ 4$$の時は、$d = 0$であっても、有意に達しないということをまず認識しておかなければならない。
つまり、一巡三角形が０個であっても有意な順位があることにはならず、試料数が最低でも5個以上でないと検定結果を有効活用できないので注意が必要。

# 計算式

計算式を以下に示す[^2] [^3]
一巡三角形の個数dは次の式で表す

$$d = {}_k C_2$$

$$- \sum_{i=1}^k {}_{a _i}C _2$$

展開

$${}_k \mathrm{C}_2 = \frac{k!}{2!(k-2)!} = \frac{1}{6}k(k-1)(k-2)$$


$$ a_i \mathrm{C}_2 = \frac{a _i !}{2! (a _i -2) !} = \frac{1}{2}  a _i(a _i-1)$$


$$d = \frac{1}{6}k(k-1)(k-2)-\frac{1}{2}\sum_{i=1}^k a_i(a_i-1)$$

$k$は試料数を示しており、$a_i$は試料iが得た票の合計を示す（表1を参照）

自由度$f$は次の式で表す

$$f = \frac{k(k-1)(k-2)}{(k-4)^2}$$

一意性の係数$\zeta$は次の式で表す($k$が偶数の時)

$$\zeta = 1 - \frac{24d}{k^3 - 4k}$$

一意性の係数$\zeta$は次の式で表す($k$が奇数の時)

$$\zeta = 1 - \frac{24d}{k^3 - k}$$

カイ二乗値は以下の式で表す

$$\chi_o^2= \frac{8}{k-4} ｛ \frac{k(k-1)(k-2)}{24} -d + \frac{1}{2} ｝ +f$$

カイ二乗分布表(表2)より，例えば有意水準5%での被験者の判定は首尾一貫しているといえるかどうか判断する。

### 表2

| 自由度 | 有意水準 .05 | 有意水準 .01 |
| :---: | :---: | :---: |
| 1 | 3.841 | 6.635 |
| 2 | 5.991 | 9.210 |
| 3 | 7.815 | 11.345 |
| 4 | 9.488 | 13.277 |
| 5 | 11.070 | 15.086 |
| 6 | 12.592 | 16.812 |
| 7 | 14.067 | 18.475 |
| 8 | 15.507 | 20.090 |
| 9 | 16.919 | 21.666 |
| 10 | 18.307 | 23.209 |
| - | - | - |
| 11 | 19.675 | 24.725 |
| 12 | 21.026 | 26.217 |
| 13 | 22.362 | 27.688 |
| 14 | 23.685 | 29.141 |
| 15 | 24.996 | 30.578 |
| 16 | 26.296 | 32.000 |
| 17 | 27.587 | 33.409 |
| 18 | 28.869 | 34.805 |
| 19 | 30.144 | 36.191 |
| 20 | 31.410 | 37.566 |
| - | - | - |
| 21 | 32.671 | 38.932 |
| 22 | 33.924 | 40.289 |
| 23 | 35.172 | 41.638 |
| 24 | 36.415 | 42.980 |
| 25 | 37.652 | 44.314 |
| 26 | 38.885 | 45.642 |
| 27 | 40.113 | 46.963 |
| 28 | 41.337 | 48.278 |
| 29 | 42.557 | 49.588 |
| 30 | 43.773 | 50.892 |

引用: 山田剛史・村井潤一郎「よくわかる心理統計」付表3より[^4]

# Python3を用いて実際にデータ集計から一意性の検定までを行う

### 流れ

+ 試料の準備
+ 試料の提示と実験
+ データ集計
+ 実験データをcsvに出力
+ csvデータから一巡三角形の個数$d$を算出
+ csvデータから自由度$f$を算出
+ csvデータから一意性の係数$\zeta$を算出
+ csvデータからカイ二乗値$\chi_o^2$を算出
+ 算出した$\chi_o^2$とカイ二乗分布表(表2)を用いて一意性の検定を行う

## 試料の準備
試料の準備の際に注意しなければならない点
**kは試料数を表しています**
上述の通りだが、

$$k = 5$$の時、一巡三角形の数（$d$）が0個の場合には一意性あるといえる。
ただし、１個以上の場合には一意性がないと判断できるが、検定の有意水準が通常の5%ではなく、12%水準での検定となる。

また、$$k ≦ 4$$の時は、$d = 0$であっても、有意に達しないということをまず認識しておかなければならない。
つまり、一巡三角形が０個であっても有意な順位があることにはならず、
**試料数が最低でも5個以上**でないと検定結果を有効活用できないので注意が必要。

## 試料の提示と実験
試料の準備ができたら、試料について言語化、あるいは図化し、アイコンとして提示できる形にしていく。
このアイコンは自分にとっても被験者にとってもわかりやすい形にしておくのがベスト、最悪アルファベットを並べるだけでもアイコンとしては機能する。(例えば、前述のA~Fなど)
そしてもし被験者が１人で一対比較を行った場合，表3の一巡三角形の個数$d$の値のとき有意水準5%で「判断者に識別力がないこと」を棄却できることが知られている。[^5]

### 表3
|k|5以下|6|7|8|9|
| :---: | :---: | :---: | :---: | :---: | :---: |
| d | 有意水準5%に達しない | 1以下 | 3以下 | 7以下 | 14以下
| ${}_kC_3$ | 10以下 | 20 | 35 | 56 | 84 |

## データ集計、PCPSによって得られた実験データをcsvに出力


即席で実験補助アプリとして「一対比較法実験集計システムver2:2021,1,3 Paired comparison method data processing software, codename PCPS」を作った(以下 PCPSと呼ぶ)

今日（2021/01/03）はPCPSを調整していました、詳細については後日書き加えます。

**csvデータから一巡三角形の個数$d$を算出**
***

**csvデータから自由度$f$を算出**
***

**csvデータから一意性の係数$\zeta$を算出**
***

**csvデータからカイ二乗値$\chi_o^2$を算出**
***

**算出した$\chi_o^2$とカイ二乗分布表(表2)を用いて一意性の検定を行う**
***





### 参考
[^1]: 「一対比較法」 感性・官能評価システム J-SEMS https://j-sems.com/%E4%B8%80%E5%AF%BE%E6%AF%94%E8%BC%83%E6%B3%95/

[^2]: 「PC 画面上で見る三原色の季節感について」 https://core.ac.uk/download/pdf/233608433.pdf

[^3]: 修士論文 「拡張現実間における擬似触覚を用いた力覚フィードバック提示手法」 東京大学大学院工学系研究科電気系工学専攻 大塚 隆史 平成25年2月6日

[^4]: 「よくわかる心理統計」 山田剛史・村井潤一郎 ミネルヴァ書房

[^5]: 「AHPにおける一対比較法に関する一考察 官能検査における一対比較法の利用」 飯田洋市
